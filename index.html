



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>decopatch</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#decopatch" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="decopatch" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              decopatch
            </span>
            <span class="md-header-nav__topic">
              Home
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/smarie/python-decopatch/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="decopatch" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    decopatch
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/smarie/python-decopatch/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" title="Motivation" class="md-nav__link">
    Motivation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-problem" title="a- Problem" class="md-nav__link">
    a- Problem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-solution" title="b- Solution" class="md-nav__link">
    b- Solution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-why-something-new" title="c- Why something new ?" class="md-nav__link">
    c- Why something new ?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-flat-mode" title="a- Flat mode" class="md-nav__link">
    a- Flat mode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg" title="1- Simple with mandatory arg" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-same-with-all-optional-args" title="2- Same with all-optional args" class="md-nav__link">
    2- Same with all-optional args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-function-wrapper-creator" title="3- Function wrapper creator" class="md-nav__link">
    3- Function wrapper creator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-class-decorator" title="4- Class decorator" class="md-nav__link">
    4- Class decorator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-classfunction-decorator" title="5- Class+Function decorator" class="md-nav__link">
    5- Class+Function decorator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-nested-mode" title="b- Nested mode" class="md-nav__link">
    b- Nested mode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg_1" title="1- Simple with mandatory arg" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-behind-the-scenes" title="c- Behind the scenes" class="md-nav__link">
    c- Behind the scenes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" title="See Also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" title="Others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" title="Want to contribute ?" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" title="Motivation" class="md-nav__link">
    Motivation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-problem" title="a- Problem" class="md-nav__link">
    a- Problem
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-solution" title="b- Solution" class="md-nav__link">
    b- Solution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-why-something-new" title="c- Why something new ?" class="md-nav__link">
    c- Why something new ?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-flat-mode" title="a- Flat mode" class="md-nav__link">
    a- Flat mode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg" title="1- Simple with mandatory arg" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-same-with-all-optional-args" title="2- Same with all-optional args" class="md-nav__link">
    2- Same with all-optional args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-function-wrapper-creator" title="3- Function wrapper creator" class="md-nav__link">
    3- Function wrapper creator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-class-decorator" title="4- Class decorator" class="md-nav__link">
    4- Class decorator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-classfunction-decorator" title="5- Class+Function decorator" class="md-nav__link">
    5- Class+Function decorator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-nested-mode" title="b- Nested mode" class="md-nav__link">
    b- Nested mode
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg_1" title="1- Simple with mandatory arg" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-behind-the-scenes" title="c- Behind the scenes" class="md-nav__link">
    c- Behind the scenes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" title="See Also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" title="Others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" title="Want to contribute ?" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/smarie/python-decopatch/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="decopatch">decopatch<a class="headerlink" href="#decopatch" title="Permanent link">&para;</a></h1>
<p><em>python decorators made easy.</em></p>
<p><a href="https://pypi.python.org/pypi/decopatch/"><img alt="Python versions" src="https://img.shields.io/pypi/pyversions/decopatch.svg" /></a> <a href="https://travis-ci.org/smarie/python-decopatch"><img alt="Build Status" src="https://travis-ci.org/smarie/python-decopatch.svg?branch=master" /></a> <a href="https://smarie.github.io/python-decopatch/junit/report.html"><img alt="Tests Status" src="https://smarie.github.io/python-decopatch/junit/junit-badge.svg?dummy=8484744" /></a> <a href="https://codecov.io/gh/smarie/python-decopatch"><img alt="codecov" src="https://codecov.io/gh/smarie/python-decopatch/branch/master/graph/badge.svg" /></a></p>
<p><a href="https://smarie.github.io/python-decopatch/"><img alt="Documentation" src="https://img.shields.io/badge/doc-latest-blue.svg" /></a> <a href="https://pypi.python.org/pypi/decopatch/"><img alt="PyPI" src="https://img.shields.io/pypi/v/decopatch.svg" /></a> <a href="https://pepy.tech/project/decopatch"><img alt="Downloads" src="https://pepy.tech/badge/decopatch" /></a> <a href="https://pepy.tech/project/decopatch"><img alt="Downloads per week" src="https://pepy.tech/badge/decopatch/week" /></a> <a href="https://github.com/smarie/python-decopatch/stargazers"><img alt="GitHub stars" src="https://img.shields.io/github/stars/smarie/python-decopatch.svg" /></a></p>
<p>Because of a tiny oddity in the python language, writing decorators without help can be a pain. <code>decopatch</code> provides a simple way to solve this issue.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<h3 id="a-problem">a- Problem<a class="headerlink" href="#a-problem" title="Permanent link">&para;</a></h3>
<p>In python, a decorator used without arguments such as </p>
<div class="codehilite"><pre><span></span><span class="nd">@say_hello</span>  <span class="c1"># (1) no-parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>requires a completely different implementation code than</p>
<div class="codehilite"><pre><span></span><span class="nd">@say_hello</span><span class="p">()</span>  <span class="c1"># (2) empty-parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<p>Indeed (1) requires <code>say_hello</code> to directly return a replacement for the decorated object (in that case function <code>foo</code>), while (2) requires <code>say_hello</code> to return a <strong>function</strong> that returns a replacement for the decorated object ! This is one more level of nesting. If you wish to handle both situations in a robust way, <strong>you end-up having to design some ridiculously complex code</strong>, relying on some well-known "tricks" based either on checking the type or existence of first argument provided. For example:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># this is (1) @say_hello (without parenthesis)</span>
        <span class="c1"># we have to directly return a replacement for f</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is (2) @say_hello()</span>
        <span class="c1"># we have to return a decorator function</span>
        <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
                <span class="o">...</span>
            <span class="k">return</span> <span class="n">new_f</span>
        <span class="k">return</span> <span class="n">decorate</span>
</pre></div>


<p>Unfortunately, the 'trick' to use is different for almost every type of decorator signature (var-args, keyword-only, all-optional, ...). So if you change your mind about your API during development time (this often happens, at least to me :)), you end up having to change this useless piece of code several times!</p>
<h3 id="b-solution">b- Solution<a class="headerlink" href="#b-solution" title="Permanent link">&para;</a></h3>
<p><code>decopatch</code> provides a simple way to solve this issue. It always uses the best "trick", so that you do not have to care, you just implement one case:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_decorate_f</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">return</span> <span class="n">_decorate_f</span>
</pre></div>


<p>To ease things even more, <code>decopatch</code> also supports a <em>flat</em> mode:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span><span class="p">,</span> <span class="n">DECORATED</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="k">return</span> <span class="n">new_f</span>
</pre></div>


<p>In both cases, generated decorators have a proper <code>help</code> and <code>signature</code>, so users do not see the difference.</p>
<h3 id="c-why-something-new">c- Why something new ?<a class="headerlink" href="#c-why-something-new" title="Permanent link">&para;</a></h3>
<p>As opposed to the great <a href="https://github.com/micheles/decorator"><code>decorator</code></a> and <a href="https://wrapt.readthedocs.io/"><code>wrapt</code></a> libraries, <code>decopatch</code> does not try <strong>at the same time</strong> to help you create decorators and function wrappers. In my opinion creating function wrappers is a completely independent topic, you can wish to do it in with a decorator OR without. </p>
<p>Nevertheless since it is an important use case, I show below how to do it. If you're interested in this topic, see <a href="https://smarie.github.io/python-makefun/"><code>makefun</code></a>, my fork of <code>decorator</code>'s core engine supporting additional use cases such as signature modification.</p>
<h2 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>&gt; pip install decopatch
</pre></div>


<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="a-flat-mode">a- Flat mode<a class="headerlink" href="#a-flat-mode" title="Permanent link">&para;</a></h3>
<p>In this mode the decorator is implemented as a function, that should return the replacement for the decorated item. To create a decorator you have to do two things:</p>
<ul>
<li>use <code>@function_decorator</code>, <code>@class_decorator</code> or <code>@decorator</code> on your implementation function</li>
<li>declare which variable represents the injected decorated item by using the <code>DECORATED</code> keyword as its default value. </li>
</ul>
<p>Note: if you can not or do not want to add the <code>DECORATED</code> default value, you can specify the variable name explicitly with <code>wraps=&lt;argname&gt;</code>.</p>
<h4 id="1-simple-with-mandatory-arg"><em>1- Simple with mandatory arg</em><a class="headerlink" href="#1-simple-with-mandatory-arg" title="Permanent link">&para;</a></h4>
<p>Let's create a simple <code>@add_tag</code> decorator that adds a tag on the decorated function:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span><span class="p">,</span> <span class="n">DECORATED</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator adds the &#39;my_tag&#39; tag on the decorated function,</span>
<span class="sd">    with the value provided as argument</span>

<span class="sd">    :param tag: the tag value to set</span>
<span class="sd">    :param f: represents the decorated item. Automatically injected.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</pre></div>


<p>You can test that your new <code>@add_tag</code> decorator works:</p>
<div class="codehilite"><pre><span></span><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="c1"># let&#39;s check that the `foo` function has been correctly decorated</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>


<p>And also that using your decorator without argument raises an error as expected:</p>
<div class="codehilite"><pre><span></span><span class="nd">@add_tag</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
</pre></div>


<p>yields <code>TypeError: add_tag() missing 1 required positional argument: 'tag'</code>.</p>
<p>Finally, note that calling the decorator with a callable as first argument is even correctly handled:</p>
<div class="codehilite"><pre><span></span><span class="nd">@add_tag</span><span class="p">(</span><span class="k">print</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="k">print</span>  <span class="c1"># works !</span>
</pre></div>


<h4 id="2-same-with-all-optional-args"><em>2- Same with all-optional args</em><a class="headerlink" href="#2-same-with-all-optional-args" title="Permanent link">&para;</a></h4>
<p>Let's modify the above example so that the argument is optional:</p>
<div class="codehilite"><pre><span></span><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;tag!&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</pre></div>


<p>You can check that everything works as expected:</p>
<div class="codehilite"><pre><span></span><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>                 <span class="c1"># normal arg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>           <span class="c1"># normal kwarg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>

<span class="nd">@add_tag</span>                      <span class="c1"># no parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;tag!&#39;</span>

<span class="nd">@add_tag</span><span class="p">()</span>                 <span class="c1"># empty parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;tag!&#39;</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="k">print</span><span class="p">)</span>        <span class="c1"># callable as first arg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="k">print</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="k">print</span><span class="p">)</span>  <span class="c1"># callable as first kwarg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="k">print</span>
</pre></div>


<h4 id="3-function-wrapper-creator"><em>3- Function wrapper creator</em><a class="headerlink" href="#3-function-wrapper-creator" title="Permanent link">&para;</a></h4>
<p>In real-world applications you often wish to not only modify the decorated item, but to <strong>replace</strong> it with something else. </p>
<p>A typical use case is the creation of a <strong>function wrapper</strong>, for example to add behaviours to a function when decorating it. The great <code>wrapt</code> and <code>decorator</code> libraries have been designed mostly to cover this purpose, but they blend it quite tightly to the decorator creation. Below we show that the same result can be obtained by combining two distinct libraries: <code>decopatch</code> to create the decorator, and the library of your choice for the signature-preserving wrapper. In this example we use <code>makefun</code>.</p>
<p>Let's create a <code>@say_hello</code> decorator, that prints a message to stdout before each call to the decorated function. </p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span><span class="p">,</span> <span class="n">DECORATED</span>
<span class="kn">from</span> <span class="nn">makefun</span> <span class="kn">import</span> <span class="n">with_signature</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator modifies the decorated function so that a nice hello </span>
<span class="sd">    message is printed before the call.</span>

<span class="sd">    :param person: the person name in the print message. Default = &quot;world&quot;</span>
<span class="sd">    :param f: represents the decorated item. Automatically injected.</span>
<span class="sd">    :return: a modified version of `f` that will print a msg before executing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create a wrapper of f that will do the print before call</span>
    <span class="c1"># we rely on `makefun.with_signature` to preserve signature</span>
    <span class="nd">@with_signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">person</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, </span><span class="si">%s</span><span class="s2"> !&quot;</span> <span class="o">%</span> <span class="n">person</span><span class="p">)</span>  <span class="c1"># say hello</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>      <span class="c1"># call f</span>

    <span class="c1"># return the new function</span>
    <span class="k">return</span> <span class="n">new_f</span>
</pre></div>


<p>Once again, you can check that all call modes are properly implemented:</p>
<div class="codehilite"><pre><span></span><span class="nd">@say_hello</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing foo&gt;&quot;</span><span class="p">)</span>
<span class="n">foo</span><span class="p">()</span>

<span class="nd">@say_hello</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing bar&gt;&quot;</span><span class="p">)</span>
<span class="n">bar</span><span class="p">()</span>

<span class="nd">@say_hello</span><span class="p">(</span><span class="s2">&quot;you&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">custom</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing custom&gt;&quot;</span><span class="p">)</span>
<span class="n">custom</span><span class="p">()</span>
</pre></div>


<p>yields</p>
<div class="codehilite"><pre><span></span>hello, world !
&lt;executing foo&gt;
hello, world !
&lt;executing bar&gt;
hello, you !
&lt;executing custom&gt;
</pre></div>


<div class="admonition note">
<p class="admonition-title">nonlocal in python 2</p>
<p>In python 2 the <code>nonlocal</code> keyword from <a href="https://www.python.org/dev/peps/pep-3104/">PEP3104</a> is not available. See <a href="https://stackoverflow.com/a/16032631/7262247">this workaround</a></p>
</div>
<h4 id="4-class-decorator"><em>4- Class decorator</em><a class="headerlink" href="#4-class-decorator" title="Permanent link">&para;</a></h4>
<p>You can similarly use <code>@class_decorator</code> to create a decorator that works for classes.</p>
<h4 id="5-classfunction-decorator"><em>5- Class+Function decorator</em><a class="headerlink" href="#5-classfunction-decorator" title="Permanent link">&para;</a></h4>
<p>Both <code>@function_decorator</code> and <code>@class_decorator</code> are actually user-friendly presets for the more generic <code>@decorator</code>. If you wish to write a decorator that can be used both for functions and classes, you can use it.</p>
<h3 id="b-nested-mode">b- Nested mode<a class="headerlink" href="#b-nested-mode" title="Permanent link">&para;</a></h3>
<p>In <em>nested</em> mode you write your decorator's signature thinking about what the <strong>user</strong> will have to enter. So for example if you wish to create <code>@say_hello(person)</code> you will define <code>def say_hello(person)</code>. In that case your function has to return a function. </p>
<p>In other words, <em>nested</em> mode is equivalent to how you write python decorators with arguments today, except that you do not have to write anything special to handle the case where your decorator is used without parenthesis. It is silently redirected to the case where it is used with parenthesis. </p>
<p>To write decorators in this mode, you only have to decorate them with <code>@function_decorator</code>, <code>@class_decorator</code> or <code>@decorator</code>.</p>
<h4 id="1-simple-with-mandatory-arg_1"><em>1- Simple with mandatory arg</em><a class="headerlink" href="#1-simple-with-mandatory-arg_1" title="Permanent link">&para;</a></h4>
<p>We can reproduce the same example than above, in this alternate style:</p>
<div class="codehilite"><pre><span></span><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator adds the &#39;my_tag&#39; tag on the decorated function,</span>
<span class="sd">    with the value provided as argument</span>

<span class="sd">    :param tag: the tag value to set</span>
<span class="sd">    :param f: represents the decorated item. Automatically injected.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">replace_f</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">replace_f</span>
</pre></div>


<p>You can test that your new <code>@add_tag</code> decorator works:</p>
<div class="codehilite"><pre><span></span><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="c1"># let&#39;s check that the `foo` function has been correctly decorated</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>


<h3 id="c-behind-the-scenes">c- Behind the scenes<a class="headerlink" href="#c-behind-the-scenes" title="Permanent link">&para;</a></h3>
<p>When you use <code>@function_decorator</code> or the like, your function is dynamically replaced with another one with the same signature (if you're in <em>nested</em> mode) or where the <code>f</code> parameter is removed (if you're in <em>flat</em> mode). You can see it by using <code>help</code> on your function, or by looking at its signature:</p>
<div class="codehilite"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">say_hello</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Signature: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">signature</span><span class="p">(</span><span class="n">say_hello</span><span class="p">))</span>
</pre></div>


<p>yields</p>
<div class="codehilite"><pre><span></span>Help on <span class="k">function</span> say_hello in module my_module:

say_hello<span class="o">(</span><span class="nv">person</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="o">)</span>
    This decorator modifies the decorated <span class="k">function</span> so that a nice hello
    message is printed before the call.

    :param person: the person name in the print message. <span class="nv">Default</span> <span class="o">=</span> <span class="s2">&quot;world&quot;</span>
    :return:

Signature: <span class="o">(</span><span class="nv">person</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="o">)</span>
</pre></div>


<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/micheles/decorator">decorator</a>, the reference library for creating decorators in python. I used it a lot before writing <code>makefun</code> and <code>decopatch</code>, big thanks to <a href="https://github.com/micheles"><code>micheles</code></a> !</li>
<li><a href="https://realpython.com/primer-on-python-decorators/">tutorial 1</a></li>
<li><a href="https://www.thecodeship.com/patterns/guide-to-python-function-decorators/">tutorial 2</a></li>
<li><a href="https://wiki.python.org/moin/PythonDecoratorLibrary">decorator recipes</a></li>
</ul>
<h3 id="others">Others<a class="headerlink" href="#others" title="Permanent link">&para;</a></h3>
<p><em>Do you like this library ? You might also like <a href="https://github.com/smarie/OVERVIEW#python">my other python libraries</a></em> </p>
<h2 id="want-to-contribute">Want to contribute ?<a class="headerlink" href="#want-to-contribute" title="Permanent link">&para;</a></h2>
<p>Details on the github page: <a href="https://github.com/smarie/python-decopatch">https://github.com/smarie/python-decopatch</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="changelog/" title="Changelog" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Changelog
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>