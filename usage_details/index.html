


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Usage details - decopatch</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#usage-details" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="decopatch" class="md-header-nav__button md-logo" aria-label="decopatch">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            decopatch
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Usage details
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/smarie/python-decopatch/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="decopatch" class="md-nav__button md-logo" aria-label="decopatch">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    decopatch
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/smarie/python-decopatch/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../motivation/" title="Motivation" class="md-nav__link">
      Motivation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disambiguation/" title="Disambiguation principes" class="md-nav__link">
      Disambiguation principes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pep_proposal/" title="PEP proposal" class="md-nav__link">
      PEP proposal
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-flat-mode" class="md-nav__link">
    a- Flat mode
  </a>
  
    <nav class="md-nav" aria-label="a- Flat mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-same-with-all-optional-args" class="md-nav__link">
    2- Same with all-optional args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-function-wrapper-creator" class="md-nav__link">
    3- Function wrapper creator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-class-decorator" class="md-nav__link">
    4- Class decorator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-classfunction-decorator" class="md-nav__link">
    5- Class+Function decorator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-nested-mode" class="md-nav__link">
    b- Nested mode
  </a>
  
    <nav class="md-nav" aria-label="b- Nested mode">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-simple-with-mandatory-arg_1" class="md-nav__link">
    1- Simple with mandatory arg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-behind-the-scenes" class="md-nav__link">
    c- Behind the scenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-advanced-topics" class="md-nav__link">
    c- Advanced topics
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/smarie/python-decopatch/edit/master/docs/usage_details.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="usage-details">Usage details<a class="headerlink" href="#usage-details" title="Permanent link">&para;</a></h1>
<p><strong>WARNING: THIS IS AN OLD PAGE WITH OUTDATED INFORMATION ! PLEASE IGNORE IT !</strong></p>
<h3 id="a-flat-mode">a- Flat mode<a class="headerlink" href="#a-flat-mode" title="Permanent link">&para;</a></h3>
<p>In this mode the decorator is implemented as a function, that should return the replacement for the decorated item. To create a decorator you have to do two things:</p>
<ul>
<li>use <code>@function_decorator</code>, <code>@class_decorator</code> or <code>@decorator</code> on your implementation function</li>
<li>declare which variable represents the injected decorated item by using the <code>DECORATED</code> keyword as its default value. </li>
</ul>
<p>Note: if you can not or do not want to add the <code>DECORATED</code> default value, you can specify the variable name explicitly with <code>decorated=&lt;argname&gt;</code>.</p>
<h4 id="1-simple-with-mandatory-arg"><em>1- Simple with mandatory arg</em><a class="headerlink" href="#1-simple-with-mandatory-arg" title="Permanent link">&para;</a></h4>
<p>Let's create a simple <code>@add_tag</code> decorator that adds a tag on the decorated function:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span><span class="p">,</span> <span class="n">DECORATED</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator adds the &#39;my_tag&#39; tag on the decorated function,</span>
<span class="sd">    with the value provided as argument</span>

<span class="sd">    :param tag: the tag value to set</span>
<span class="sd">    :param f: represents the decorated item. Automatically injected.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div>


<p>You can test that your new <code>@add_tag</code> decorator works:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="c1"># let&#39;s check that the `foo` function has been correctly decorated</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>
</code></pre></div>


<p>And also that using your decorator without argument raises an error as expected:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
</code></pre></div>


<p>yields <code>TypeError: add_tag() missing 1 required positional argument: 'tag'</code>.</p>
<p>Finally, note that calling the decorator with a callable as first argument is even correctly handled:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="nb">print</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="nb">print</span>  <span class="c1"># works !</span>
</code></pre></div>


<h4 id="2-same-with-all-optional-args"><em>2- Same with all-optional args</em><a class="headerlink" href="#2-same-with-all-optional-args" title="Permanent link">&para;</a></h4>
<p>Let's modify the above example so that the argument is optional:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;tag!&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div>


<p>You can check that everything works as expected:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>                 <span class="c1"># normal arg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>           <span class="c1"># normal kwarg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>

<span class="nd">@add_tag</span>                      <span class="c1"># no parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;tag!&#39;</span>

<span class="nd">@add_tag</span><span class="p">()</span>                 <span class="c1"># empty parenthesis</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;tag!&#39;</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="nb">print</span><span class="p">)</span>        <span class="c1"># callable as first arg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="nb">print</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>  <span class="c1"># callable as first kwarg</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="nb">print</span>
</code></pre></div>


<h4 id="3-function-wrapper-creator"><em>3- Function wrapper creator</em><a class="headerlink" href="#3-function-wrapper-creator" title="Permanent link">&para;</a></h4>
<p>In real-world applications you often wish to not only modify the decorated item, but to <strong>replace</strong> it with something else. </p>
<p>A typical use case is the creation of a <strong>function wrapper</strong>, for example to add behaviours to a function when decorating it. The great <code>wrapt</code> and <code>decorator</code> libraries have been designed mostly to cover this purpose, but they blend it quite tightly to the decorator creation. Below we show that the same result can be obtained by combining two distinct libraries: <code>decopatch</code> to create the decorator, and the library of your choice for the signature-preserving wrapper. In this example we use <code>makefun</code>.</p>
<p>Let's create a <code>@say_hello</code> decorator, that prints a message to stdout before each call to the decorated function. </p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">decopatch</span> <span class="kn">import</span> <span class="n">function_decorator</span><span class="p">,</span> <span class="n">DECORATED</span>
<span class="kn">from</span> <span class="nn">makefun</span> <span class="kn">import</span> <span class="n">with_signature</span>

<span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator modifies the decorated function so that a nice hello </span>
<span class="sd">    message is printed before the call.</span>

<span class="sd">    :param person: the person name in the print message. Default = &quot;world&quot;</span>
<span class="sd">    :param f: represents the decorated item. Automatically injected.</span>
<span class="sd">    :return: a modified version of `f` that will print a msg before executing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create a wrapper of f that will do the print before call</span>
    <span class="c1"># we rely on `makefun.with_signature` to preserve signature</span>
    <span class="nd">@with_signature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">person</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello, </span><span class="si">%s</span><span class="s2"> !&quot;</span> <span class="o">%</span> <span class="n">person</span><span class="p">)</span>  <span class="c1"># say hello</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>      <span class="c1"># call f</span>

    <span class="c1"># return the new function</span>
    <span class="k">return</span> <span class="n">new_f</span>
</code></pre></div>


<p>Once again, you can check that all call modes are properly implemented:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@say_hello</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing foo&gt;&quot;</span><span class="p">)</span>
<span class="n">foo</span><span class="p">()</span>

<span class="nd">@say_hello</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing bar&gt;&quot;</span><span class="p">)</span>
<span class="n">bar</span><span class="p">()</span>

<span class="nd">@say_hello</span><span class="p">(</span><span class="s2">&quot;you&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">custom</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;executing custom&gt;&quot;</span><span class="p">)</span>
<span class="n">custom</span><span class="p">()</span>
</code></pre></div>


<p>yields</p>
<div class="codehilite"><pre><span></span><code>hello, world !
&lt;executing foo&gt;
hello, world !
&lt;executing bar&gt;
hello, you !
&lt;executing custom&gt;
</code></pre></div>


<div class="admonition note">
<p class="admonition-title">nonlocal in python 2</p>
<p>In python 2 the <code>nonlocal</code> keyword from <a href="https://www.python.org/dev/peps/pep-3104/">PEP3104</a> is not available. See <a href="https://stackoverflow.com/a/16032631/7262247">this workaround</a></p>
</div>
<h4 id="4-class-decorator"><em>4- Class decorator</em><a class="headerlink" href="#4-class-decorator" title="Permanent link">&para;</a></h4>
<p>You can similarly use <code>@class_decorator</code> to create a decorator that works for classes.</p>
<h4 id="5-classfunction-decorator"><em>5- Class+Function decorator</em><a class="headerlink" href="#5-classfunction-decorator" title="Permanent link">&para;</a></h4>
<p>Both <code>@function_decorator</code> and <code>@class_decorator</code> are actually user-friendly presets for the more generic <code>@decorator</code>. If you wish to write a decorator that can be used both for functions and classes, you can use it.</p>
<h3 id="b-nested-mode">b- Nested mode<a class="headerlink" href="#b-nested-mode" title="Permanent link">&para;</a></h3>
<p>In <em>nested</em> mode you write your decorator's signature thinking about what the <strong>user</strong> will have to enter. So for example if you wish to create <code>@say_hello(person)</code> you will define <code>def say_hello(person)</code>. In that case your function has to return a function. </p>
<p>In other words, <em>nested</em> mode is equivalent to how you write python decorators with arguments today, except that you do not have to write anything special to handle the case where your decorator is used without parenthesis. It is silently redirected to the case where it is used with parenthesis. </p>
<p>To write decorators in this mode, you only have to decorate them with <code>@function_decorator</code>, <code>@class_decorator</code> or <code>@decorator</code>.</p>
<h4 id="1-simple-with-mandatory-arg_1"><em>1- Simple with mandatory arg</em><a class="headerlink" href="#1-simple-with-mandatory-arg_1" title="Permanent link">&para;</a></h4>
<p>We can reproduce the same example than above, in this alternate style:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This decorator adds the &#39;my_tag&#39; tag on the decorated function,</span>
<span class="sd">    with the value provided as argument</span>

<span class="sd">    :param tag: the tag value to set</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">replace_f</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">replace_f</span>
</code></pre></div>


<p>You can test that your new <code>@add_tag</code> decorator works:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="c1"># let&#39;s check that the `foo` function has been correctly decorated</span>
<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="s1">&#39;hello&#39;</span>
</code></pre></div>


<h3 id="c-behind-the-scenes">c- Behind the scenes<a class="headerlink" href="#c-behind-the-scenes" title="Permanent link">&para;</a></h3>
<p>When you use <code>@function_decorator</code> or the like, your function is dynamically replaced with another one with the same signature (if you're in <em>nested</em> mode) or where the <code>f</code> parameter is removed (if you're in <em>flat</em> mode). You can see it by using <code>help</code> on your function, or by looking at its signature:</p>
<div class="codehilite"><pre><span></span><code><span class="n">help</span><span class="p">(</span><span class="n">say_hello</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signature: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">signature</span><span class="p">(</span><span class="n">say_hello</span><span class="p">))</span>
</code></pre></div>


<p>yields</p>
<div class="codehilite"><pre><span></span><code>Help on <span class="k">function</span> say_hello in module my_module:

say_hello<span class="o">(</span><span class="nv">person</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="o">)</span>
    This decorator modifies the decorated <span class="k">function</span> so that a nice hello
    message is printed before the call.

    :param person: the person name in the print message. <span class="nv">Default</span> <span class="o">=</span> <span class="s2">&quot;world&quot;</span>
    :return:

Signature: <span class="o">(</span><span class="nv">person</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="o">)</span>
</code></pre></div>


<h3 id="c-advanced-topics">c- Advanced topics<a class="headerlink" href="#c-advanced-topics" title="Permanent link">&para;</a></h3>
<p>1 mandatory</p>
<p>either</p>
<div class="codehilite"><pre><span></span><code><span class="n">InvalidMandatoryArgError</span><span class="p">:</span> <span class="n">function</span> <span class="s1">&#39;add_tag&#39;</span> <span class="n">requires</span> <span class="n">a</span> <span class="n">mandatory</span> <span class="n">argument</span> <span class="s1">&#39;tag&#39;</span><span class="o">.</span> <span class="n">Provided</span> <span class="n">value</span> <span class="s1">&#39;&lt;function foo at 0x00000160858ED510&gt;&#39;</span> <span class="n">does</span> <span class="ow">not</span> <span class="k">pass</span> <span class="n">its</span> <span class="n">validation</span> <span class="n">criteria</span>
</code></pre></div>


<p>Note that this error is a dedicated subclass of <code>TypeError</code>, and not the native <code>TypeError</code> that python raises when a function is called without a mandatory argument. This is mostly for testability reasons, to make sure that the library worked correctly.</p>
<p>By default <strong>you cannot use a callable as first mandatory argument</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="nb">print</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
</code></pre></div>


<p>raises</p>
<div class="codehilite"><pre><span></span><code><span class="n">InvalidMandatoryArgError</span><span class="p">:</span> <span class="n">function</span> <span class="s1">&#39;add_tag&#39;</span> <span class="n">requires</span> <span class="n">a</span> <span class="n">mandatory</span> <span class="n">argument</span> <span class="s1">&#39;tag&#39;</span><span class="o">.</span> <span class="n">Provided</span> <span class="n">value</span> <span class="s1">&#39;&lt;built-in function print&gt;&#39;</span> <span class="n">does</span> <span class="ow">not</span> <span class="k">pass</span> <span class="n">its</span> <span class="n">validation</span> <span class="n">criteria</span>
</code></pre></div>


<p>Indeed there is absolutely no way in the python language to disambiguate this case with the previous one without user-provided disambiguation rules. Since we wanted to avoid silent incorrect behaviour in the previous (no-parenthesis) usage, then the consequence is that we have an error in this usage that seems legitimate. </p>
<p><strong>It is very easy to fix this</strong>: if you wish to accept callables/classes as first mandatory argument, the simplest thing to do is to <strong>force keyword usage</strong> (adding a star as first argument):</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; We use the * in the signature to disambiguate &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div>


<p>Now your decorator will be entirely not ambiguous, users will be able to pass callables to it while still getting an error in case they use it without arguments.</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="nb">print</span><span class="p">)</span>  <span class="c1"># &gt;&gt; disambiguated: now works correctly</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>

<span class="k">assert</span> <span class="n">foo</span><span class="o">.</span><span class="n">my_tag</span> <span class="o">==</span> <span class="nb">print</span>

<span class="nd">@add_tag</span>  <span class="c1"># &gt;&gt; disambiguated: raises the standard TypeError now</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span>
</code></pre></div>


<p>Note: if you do not want to use this trick, there are other, more cumbersome ways to perform the disambiguation. See <a href="">this section on first argument disambiguation</a>.</p>
<p>1 optional</p>
<p>Let's modify the previous decorator so that its <code>tag</code> argument is optional:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@function_decorator</span>
<span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;tag!&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;my_tag&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
</code></pre></div>


<p>You see that <code>decopath</code> does not accept it:</p>
<div class="codehilite"><pre><span></span><code><span class="n">AmbiguousDecoratorDefinitionError</span><span class="p">:</span> <span class="n">This</span> <span class="n">decorator</span> <span class="ow">is</span> <span class="n">ambiguous</span> <span class="n">because</span> <span class="n">it</span> <span class="n">has</span> <span class="n">only</span> <span class="n">optional</span> <span class="n">arguments</span><span class="o">.</span> <span class="n">Please</span> <span class="n">provide</span> <span class="n">an</span> <span class="n">explicit</span> <span class="n">protection</span><span class="o">.</span>
</code></pre></div>


<p>Indeed this is a very ambiguous decorator: the decorator </p>
<ul>
<li>can be used without arguments: <code>@add_tag</code> or <code>@add_tag()</code></li>
<li>but it can also be used with arguments: <code>@add_tag('hello')</code>. In particular it can be used with a callable as first argument such as in <code>@add_tag(print)</code></li>
</ul>
<p>The python language is not able to see the difference between using <code>@add_tag</code> to decorate a function named <code>print</code>, and <code>@add_tag(print)</code> applied to decorate another function:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># the following two usages are programmatically undetectable</span>
<span class="c1"># except if we cheat and look at the source code</span>

<span class="nd">@add_tag</span>
<span class="k">def</span> <span class="nf">print</span><span class="p">():</span>
    <span class="k">return</span>

<span class="nd">@add_tag</span><span class="p">(</span><span class="nb">print</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">another</span><span class="p">():</span>
    <span class="k">return</span>    
</code></pre></div>


<p>, and therefore we ask you to explicitly protect your decorator. Once again you can use the "keyword-only" trick, or if you have a good reason not to do it, see <a href="">this section on first argument disambiguation</a>.</p>
<p>Wrapper</p>
<p>Note that this time usage without arguments is permitted, as long as the value provided for the first argument is not a callable - as that would be ambiguous.</p>
<p>In very rare cases, you want to create a decorator  </p>
<ul>
<li>that accepts to be called with a single argument (i.e. it has a single mandatory argument, or only optional ones)</li>
<li>where the first argument in the signature, except the <code>DECORATED</code> one, is a callable or a class. </li>
</ul>
<p>For example the following dummy decorator will replace the decorated function with its argument:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">replace_with</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;replace the decorated function with its argument&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">g</span>
</code></pre></div>


<p>If you try to use it</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="nd">@replace_with</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>


<p>Surprisingly it fails ! </p>
<div class="codehilite"><pre><span></span><code>TypeError: replace_with<span class="o">()</span> missing <span class="m">1</span> required positional argument: <span class="s1">&#39;g&#39;</span>
</code></pre></div>


<p>This is because there is <strong>absolutely no way in the python language</strong> (if you know one, let me know !) to disambiguate the above case from the "no-arg" usage below:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@replace_with</span>
<span class="k">def</span> <span class="nf">bar_no_arg</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>


<p>Hopefully there are many workarounds if you use <code>decopatch</code>. The easiest ones consist in changing your decorator's signature:</p>
<ul>
<li>so that the first argument is keyword-only. <strong>This is the most reliable thing to do</strong>. For this, simply add a <code>*</code> before your first argument:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">replace_with</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="c1"># ...</span>
</code></pre></div>


<ul>
<li>or if the first argument is optional, so that the callable/class is not the first in the list. In this case you have to either declare a type hint or perform manual validation in the code:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">replace_with</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="c1"># or</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">replace_with</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>
    <span class="c1"># ...</span>
</code></pre></div>


<ul>
<li>or if the first argument is mandatory, so that it is not alone (at least two mandatory arguments)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">replace_with</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">DECORATED</span><span class="p">):</span>
    <span class="c1"># ...</span>
</code></pre></div>


<p>If you can not afford a signature change, there are two other ways to work around this problem:</p>
<ul>
<li>change the default detector for first argument disambiguation. By default if a single argument is received, it will be assumed to be the true first arg (and not the decorator's target), if it is not a callable nor a class. If you are sure that a function of a certain type, or a class with certain caracteristics, can only be the argument and not the decorated object, then you can override this default logic. For example we could use <code>@decorator(first_arg_disambiguator=lambda g: g in {foo})</code> in the above code.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"search.result.one": "1 matching document", "search.config.lang": "en", "clipboard.copy": "Copy to clipboard", "search.result.none": "No matching documents", "search.config.separator": "[\\s\\-]+", "search.result.other": "# matching documents", "search.config.pipeline": "trimmer, stopWordFilter", "search.result.placeholder": "Type to start searching", "clipboard.copied": "Copied to clipboard"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>